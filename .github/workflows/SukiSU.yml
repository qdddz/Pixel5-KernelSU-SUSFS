name: Build Pixel 5 Kernel (SukiSU-Ultra)

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version (e.g., android-msm-redbull-4.19-android14)'
        default: 'android-msm-redbull-4.19-android14-qpr3'
        required: true

jobs:
  build-kernel-4-19-kernelsu-susfs-custom:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Workflow
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev

      - name: Download Clang Toolchain (ZyCromerZ Clang 14)
        run: |
          mkdir clang
          # 使用 ZyCromerZ 的预编译 Clang 14.0.0 (与 r450784d 版本相近/兼容)
          wget "https://github.com/ZyCromerZ/Clang/releases/download/14.0.6-20250704-release/Clang-14.0.6-20250704.tar.gz" -O clang.tar.gz
          tar -C clang/ -zxf clang.tar.gz
          
          # 设置环境变量
          echo "CLANG_PATH=$PWD/clang/bin" >> $GITHUB_ENV
          
          # 验证版本
          ./clang/bin/clang --version

      - name: Clone Kernel Source
        run: |
          # 克隆 Google 官方 Pixel 5 源码
          git clone https://android.googlesource.com/kernel/msm --depth=1 -b ${{ github.event.inputs.android_version }} android-kernel

      - name: Integrate SukiSU-Ultra & SUSFS
        run: |
          cd android-kernel
          
          # 1. 运行 SukiSU 集成脚本 (使用 builtin 模式，适用于 Pixel 5 4.19)
          # 注意：SukiSU 脚本通常会自动处理 KSU 和 SUSFS 的基本集成
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s builtin
          
          # 2. 修改 defconfig 以开启必要功能
          # Pixel 5 的配置文件通常是 redbull_defconfig
          CONFIG_PATH=arch/arm64/configs/redbull_defconfig
          
          echo "Applying configs to $CONFIG_PATH..."
          
          # 开启 SukiSU/KPM 必须的配置
          echo "CONFIG_KPM=y" >> $CONFIG_PATH
          echo "CONFIG_KALLSYMS=y" >> $CONFIG_PATH
          echo "CONFIG_KALLSYMS_ALL=y" >> $CONFIG_PATH
          
          # 确保开启了 OverlayFS (Magisk/KSU 常用)
          echo "CONFIG_OVERLAY_FS=y" >> $CONFIG_PATH
          
          # 如果 SukiSU 脚本未自动添加 SUSFS 配置，可以在此追加 (根据脚本行为调整)
          # echo "CONFIG_SUSFS=y" >> $CONFIG_PATH
          
          # 检查是否集成成功
          grep "SukiSU" drivers/Makefile || echo "Warning: SukiSU not found in drivers/Makefile"

      - name: Build Kernel
        run: |
          cd android-kernel
          
          # 设置环境变量
          export PATH=$CLANG_PATH:$PATH
          export ARCH=arm64
          export SUBARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_ARM32=arm-linux-gnueabi-
          export CC=clang
          
          # 关键修改 1：创建 out 目录
          mkdir -p out

          # 关键修改 2：在 make 命令中加入 O=out
          # 这会强制将所有编译产物放入 out 文件夹
          echo "Configuring kernel..."
          make O=out ARCH=arm64 redbull_defconfig

          echo "Building kernel..."
          # 尝试使用 LLVM=1 (适配新版内核) 并指定 O=out
          # 如果编译报错，可以尝试去掉 LLVM=1
          make -j$(nproc) O=out ARCH=arm64 \
               CC=clang \
               CROSS_COMPILE=aarch64-linux-gnu- \
               CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
               Image.lz4

          # 验证产物是否存在
          if [ -f "out/arch/arm64/boot/Image.lz4" ]; then
              echo "Kernel built successfully!"
              ls -lh out/arch/arm64/boot/Image.lz4
          else
              echo "Error: Image.lz4 not found!"
              exit 1
          fi
      - name: Package with AnyKernel3
        run: |
          # 克隆 AnyKernel3 (需要找一个适配 Pixel 5 的版本)
          git clone https://github.com/osm0sis/AnyKernel3
          cd AnyKernel3
          
          # 复制编译好的内核镜像
          cp ../android-kernel/out/arch/arm64/boot/Image.lz4 .
          
          # 修改 anykernel.sh 以适配 Pixel 5 (redfin/redbull)
          # 这里使用 sed 简单替换，建议根据实际情况手动调整 AnyKernel3 仓库
          sed -i 's/device.name1=maguro/device.name1=redfin/g' anykernel.sh
          sed -i 's/device.name2=toroplus/device.name2=redbull/g' anykernel.sh
          
          # 打包
          zip -r9 Pixel5-SukiSU-Ultra.zip * -x .git README.md *placeholder

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Pixel5-SukiSU-Kernel
          path: AnyKernel3/Pixel5-SukiSU-Ultra.zip
